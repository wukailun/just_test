% zns2 = number of chunks
n = 200;
p_inhib = 0.05;
ncj = 20;
zns2 = 30; % 每一团神经元的数量
sn = zns2*n;
runtime = 400;

inht = zeros(zns2,runtime + 20);
nkr1 = rand(1);
nkr1 = round(nkr1*90 + 1)
nkr2 = rand(1);
nkr2 = round(nkr2*90 + 1)
ztt = zeros(runtime,zns2 + 1);
inact = zeros(sn,1);
trace = zeros(sn,1);
nacell = zeros(1,zns2);
dint1 = [0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2];
dint2 = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
dint2 = zeros(30,1);
dint1 = zeros(30,1);
dint1 = dint1 + 0.3;
dint2 = dint2 + 5;
njacell = zeros(sn,runtime);
wdint1 = [2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,  0,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.7,0.5,0.3,0.25,0.1,   0,  0,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,  0,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,  0,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,0.05,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,0.1,   0,0
          2,1.8,1.5,1.2,1,0.7,0.5,0.3,0.25,0.1,   0,  0,   0,0
          2,1.8,1.5,1.2,1,0.8,0.6,0.5,0.4,0.31,0.25,  0,   0,0
          1,  2,  3,  4,5,  6,  7,  8,  9,  10,  11, 12,13,14];
wdint2 = [2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          2,1.6,  1,0.6,0.4,0.3,0.2,0.1, 0,  0,   0,  0,   0,0
          1,  2,  3,  4,  5,  6,  7,  8, 9, 10,  11, 12,  13,14];
tic;
inc = 1;
for tt = 1:runtime
    tt
    nkr1 = rand(1);
    nkr1 = round(nkr1*90 + 1);
    nkr2 = rand(1);
    nkr2 = round(nkr2*90 + 1);
    nkr3 = rand(1);
    nkr3 = round(nkr3*90 + 1);
    nkr4 = rand(1);
    nkr4 = round(nkr4*90 + 1);
    %nkr1 = 1;
    %nkr2 = nkr1;
    %nkr3 = nkr1;
    nkr4 = 11;
    zk1 = mod(tt,1);
    if tt > 100
        %zk = 3;
    end
    rt = 1;
    input = zeros(sn,1);
    winput = 1;
    for r = 1:n
        krr = rand(1);
        if zk1 == 1
            %input(r,1) = winput*(0.9 + 0.39*krr)*input01(r,nkr1);
            input((inc - 1)*n + r,1) = winput*(0.9 + 0.39*krr)*hpinp(r,nkr1);
        end
        if zk1 == 2
            input((inc - 1)*n + r,1) = winput*(0.9 + 0.39*krr)*hpinp(r,nkr2);
        end
        if zk1 == 3
            input((inc - 1)*n + r,1) = winput*(0.9 + 0.39*krr)*hpinp(r,nkr3);
        end
        if zk1 == 0
            input((inc - 1)*n + r,1) = winput*(0.9 + 0.39*krr)*hpinp(r,nkr4);
        end
    end
    hp1 = 3;
    hp2 = 8;
    hp3 = 21;
    whp = 0;
    zk2 = mod(tt,12);

    nkr1 = 21;
    nkr2 = 22;
    nkr3 = 21;
    nkr4 = 21;
    nkr5 = 21;
    nkr6 = 21;
    nkr7 = 21;
    nkr8 = 21;
    
    if zk2 == 1
        for r = (hp1 - 1)*n + 1:hp1*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp1 - 1)*n,nkr1);
        end
        for r = (hp2 - 1)*n + 1:hp2*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp2 - 1)*n,nkr1);
        end
        for r = (hp3 - 1)*n + 1:hp3*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp3 - 1)*n,nkr1);
        end
    end
    if zk2 == 2
        for r = (hp1 - 1)*n + 1:hp1*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp1 - 1)*n,nkr2);
        end
        for r = (hp2 - 1)*n + 1:hp2*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp2 - 1)*n,nkr2);
        end
        for r = (hp3 - 1)*n + 1:hp3*n
            krr = rand(1);
            input(r,1) = whp*(0.9 + 0.39*krr)*input01(r - (hp3 - 1)*n,nkr2);
        end
    end
    for r = n + 1:sn
        %input(r,1) = 0;
    end
    for r = 1:zns2
        for s = 1:n
            krr2 = rand(1);
            if krr2 > p_inhib;
                input((r - 1)*n + s,1) = input((r - 1)*n + s,1) + inht(r,tt);
            end
        end
    end
    jacell = celljump14(sn,connect,input,inact,1);
    sic1 = 1;
    sic2 = 1;
    sic3 = 1;
    sic4 = 1;
    for k = 1:n
        %inact((sic1 - 1)*n + k,1) = 0;
        %jacell((sic1 - 1)*n + k,1) = 0;
        %inact((sic2 - 1)*n + k,1) = 0;
        %jacell((sic2 - 1)*n + k,1) = 0;
        %inact((sic3 - 1)*n + k,1) = 0;
        %jacell((sic3 - 1)*n + k,1) = 0;
        %inact((sic4 - 1)*n + k,1) = 0;
        %jacell((sic4 - 1)*n + k,1) = 0;
    end
    for k = 1:n
        if hpinp(k,1) == 0
            %inact(k,1) = 0;
            %jacell(k,1) = 0;
        end
    end
    for r = 1:sn
        njacell(r,tt) = jacell(r,1);
    end
    for r = 1:sn
        if jacell(r,1) == 1
            trace(r,1) = trace(r,1) + 1;
        end
    end
    for r = 1:sn
        inact(r) = jacell(r,1);
    end
    %ttinact = inact'
    nacell = zeros(zns2,1);
    for r = 1:zns2
        for s = 1:n
            if jacell((r - 1)*n + s,1) == 1
                nacell(r) = nacell(r) + 1;
            end
        end
    end
    ztt(tt,1) = tt;
    for r = 1:zns2
        ztt(tt,r + 1) = nacell(r);
    end
    ttnacell = nacell'
    for r = 1:zns2
        if nacell(r) > 20
            for s = 1:10
                inht(r,tt+s) = inht(r,tt+s) - wdint1(r,s)*dint1(r);
            end
        end
        if nacell(r) > 50
            for s = 1:6
                inht(r,tt+s) = inht(r,tt+s) - wdint2(r,s)*dint2(r);
            end
        end
    end
end
toc;
ztt

ztt1 = zeros(runtime,zns2);
for k = 1:runtime
    for r = 1:zns2
        ztt1(k,r) = ztt(k,r + 1);
    end
end
sztt = zeros(runtime,1);
for k = 1:runtime
    for r = 1:zns2
        sztt(k) = sztt(k) + ztt1(k,r);
    end
end
sztt
ff = zeros(runtime,1);
for k = 1:runtime
    ff(k) = k;
end
plot(ff,sztt);
figure;imagesc(ztt1)
noten = 33;
njacellex4(:,:,noten) = njacell;
traceex4(:,:,noten) = trace;
%trace = traceex4(:,:,1);